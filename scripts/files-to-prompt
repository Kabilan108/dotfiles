#!/bin/bash

# Exit on error
set -e

# Function to escape any special XML characters in the file content
escape_xml() {
    # Replace & with &amp;, < with &lt;, > with &gt;
    sed 's/&/\&amp;/g; s/</\&lt;/g; s/>/\&gt;/g'
}

# Get the target directory from command line argument, default to current directory
target_dir="${1:-.}"

# Convert to absolute path
target_dir=$(realpath "$target_dir")

# Check if directory exists
if [ ! -d "$target_dir" ]; then
    echo "Error: Directory '$target_dir' does not exist" >&2
    exit 1
fi

# Change to the target directory
cd "$target_dir"

# Use find to get all files, excluding .git directory
find . -type f \
    ! -path "./.git/*" \
    ! -name ".DS_Store" \
    -print0 | while IFS= read -r -d '' file; do
    # Remove leading ./
    file="${file#./}"

    # Get absolute path
    absolute_path="$target_dir/$file"

    # Output the opening tag with the path
    echo "<file path='$absolute_path'>"

    # Output the file content with XML escaping
    cat "$absolute_path" | escape_xml

    # Output the closing tag
    echo "</file>"

    # Add a newline for readability
    echo ""
done
