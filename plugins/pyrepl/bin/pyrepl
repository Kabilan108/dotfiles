#!/bin/bash

set -e

WITH_PKGS=""
HELP=false
PORT=${PORT:-5000} # Default port

while [[ $# -gt 0 ]]; do
    case $1 in
        --port)
            PORT="$2"
            shift 2
            ;;
        --with-pkgs)
            WITH_PKGS="$2"
            shift 2
            ;;
        --help)
            HELP=true
            shift 1
            ;;
        *) # Handle unknown options if necessary
            echo "Unknown option: $1"
            HELP=true
            ;;
    esac
done

if $HELP; then
    echo "Usage: pyrepl [options]"
    echo "Options:"
    echo "  --port <port>       Specify the port to use (default: 5000)."
    echo "  --with-pkgs <pkgs>  Comma-separated list of *additional* packages to install."
    echo "                      ipython, rich, matplotlib, Pillow, and ./icat are always included."
    echo "  --help              Display this help message."
    exit 0
fi

SCRIPT_DIR="$(dirname $(realpath "${BASH_SOURCE[0]}"))"
if [ -z "$PYREPL_PORT" ]; then
  export PYREPL_PORT=$PORT
fi

PKGS="rich,ipython-icat"
if [[ -n "$WITH_PKGS" ]]; then
    PKGS="$PKGS,$WITH_PKGS"
fi

echo "Starting pyrepl server on port $PYREPL_PORT with packages: $PKGS"
uv run --with "$PKGS" "$SCRIPT_DIR/server.py"

# vim: set ft=bash:
