#! /bin/bash

# Check if required tools are installed
for cmd in kdocker wmctrl; do
    if ! command -v $cmd &> /dev/null; then
        echo "$cmd is not installed. Please install it first."
        exit 1
    fi
done

FLATPAK_COMMAND="flatpak run org.mozilla.Thunderbird"

# Function to get the window ID
get_window_id() {
    wmctrl -l | grep -i "Mozilla Thunderbird" | awk '{print $1}' | head -n 1
}

# Function to check if Thunderbird is running
is_thunderbird_running() {
    pgrep -f "flatpak run.*Thunderbird" > /dev/null
}

# Launch Thunderbird if it's not already running
if ! is_thunderbird_running; then
    echo "Launching Thunderbird..."
    $FLATPAK_COMMAND &
    
    # Wait for Thunderbird to start
    echo "Waiting for Thunderbird to start..."
    sleep 10
else
    echo "Thunderbird is already running."
fi

# Wait for the window to appear
echo "Detecting Thunderbird window..."
for i in {1..10}; do
    if WINDOW_ID=$(get_window_id); then
        echo "Thunderbird window detected with ID: $WINDOW_ID"
        break
    fi
    sleep 1
done

if [ -z "$WINDOW_ID" ]; then
    echo "Failed to detect Thunderbird window."
    exit 1
fi

# Launch kdocker
echo "Launching kdocker..."
kdocker -w "$WINDOW_ID" -q

# Keep the script running to maintain the tray icon
while is_thunderbird_running; do
    sleep 2
done

echo "Thunderbird has closed. Exiting script."
